<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="last-modified" content="2017-03-03 15:16:12 +0100">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- meta "search-domain" used for google site search function google_search() -->
    <meta name="search-domain" value="">
    <link rel="stylesheet" type="text/css" href="../assets/css/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="../assets/css/bootstrap-theme.css" />
    <link rel="stylesheet" type="text/css" href="../assets/css/lesson.css" />
    
    <link rel="shortcut icon" type="image/x-icon" href="/favicon-swc.ico" />
    
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
	<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
	<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
	<![endif]-->
    <title>HPC in a day: Searching for the answer to life, the universe and everything</title>
  </head>
  <body>
    <div class="container">
      
<nav class="navbar navbar-default">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      
      
      <a href="https://software-carpentry.org" class="pull-left">
        <img class="navbar-logo" src="../assets/img/swc-icon-blue.svg" alt="Software Carpentry logo" />
      </a>
      

      
      <a class="navbar-brand" href="../">Home</a>

    </div>
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">

	
        <li><a href="../conduct/">Code of Conduct</a></li>

	
        
        <li><a href="../setup/">Setup</a></li>
        <li><a href="../reference/">Reference</a></li>
        <li class="dropdown">
          <a href="../" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Episodes <span class="caret"></span></a>
          <ul class="dropdown-menu">
            
            <li><a href="../02-01-batch-systems-101/">Batch systems and schedulers 101</a></li>
            
            <li><a href="../02-02-advanced-job-scheduling/">Working with the scheduler</a></li>
            
            <li><a href="../03-01-parallel-estimate-of-pi/">Parallel Estimation of Pi for Pedestrians</a></li>
            
            <li><a href="../03-02-mpi-for-pi/">Distributing computations among computers</a></li>
            
            <li><a href="../03-03-mapreduce-for-pi/">Searching for the answer to life, the universe and everything</a></li>
            
          </ul>
        </li>
	

	
	
        <li class="dropdown">
          <a href="../" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Extras <span class="caret"></span></a>
          <ul class="dropdown-menu">
            
          </ul>
        </li>
	

	
        <li><a href="../license/">License</a></li>
      </ul>
      <form class="navbar-form navbar-right" role="search" id="search" onsubmit="google_search(); return false;">
        <div class="form-group">
          <input type="text" id="google-search" placeholder="Search..." aria-label="Google site search">
        </div>
      </form>
    </div>
  </div>
</nav>


<div class="row">
  <div class="col-md-1">
    <h3>
      
      <a href="../03-02-mpi-for-pi/"><span class="glyphicon glyphicon-menu-left" aria-hidden="true"></span><span class="sr-only">previous episode</span></a>
      
    </h3>
  </div>
  <div class="col-md-10">
    
    <h3 class="maintitle"><a href="../">HPC in a day</a></h3>
    <h1 class="maintitle">Searching for the answer to life, the universe and everything</h1>
    
  </div>
  <div class="col-md-1">
    <h3>
      
      <a href="../"><span class="glyphicon glyphicon-menu-up" aria-hidden="true"></span><span class="sr-only">lesson home</span></a>
      
    </h3>
  </div>
</div>


<blockquote class="objectives">
  <h2>Overview</h2>

  <div class="row">
    <div class="col-md-3">
      <strong>Teaching:</strong> 40 min
      <br/>
      <strong>Exercises:</strong> 10 min
    </div>
    <div class="col-md-9">
      <strong>Questions</strong>
      <ul>
	
	<li><p>How do I analyse a lot of large files efficiently?</p>
</li>
	
      </ul>
    </div>
  </div>

  <div class="row">
    <div class="col-md-3">
    </div>
    <div class="col-md-9">
      <strong>Objectives</strong>
      <ul>
	
	<li><p>Perform a Map-Reduce style operation to extract information from large files and collect these into one final answer.</p>
</li>
	
      </ul>
    </div>
  </div>

</blockquote>

<p>Lola comes to work the next day and finds that someone has tempered with her files. Her home directory on the cluster looks like a someone threw dices with the characters of here file names.</p>

<div class="bash highlighter-rouge"><pre class="highlight"><code>$ ls
</code></pre>
</div>

<div class="output highlighter-rouge"><pre class="highlight"><code>pi_estimate_01.data  pi_estimate_04.data  pi_estimate_07.data  pi_estimate_10.data  pi_estimate_13.data  pi_estimate_16.data
pi_estimate_02.data  pi_estimate_05.data  pi_estimate_08.data  pi_estimate_11.data  pi_estimate_14.data
pi_estimate_03.data  pi_estimate_06.data  pi_estimate_09.data  pi_estimate_12.data  pi_estimate_15.data
</code></pre>
</div>

<p>Examining the files shows, that their size has been increased by some orders of magnitude in size. She opens one of her files and finds out that the results are still there, but they are scrambled with random symbols that she never saw before. Certainly, nothing human readable. But she notices that the pi estimates are always printed on an isolated line. This is something she can exploit to extract these lines. She immediately sits down and writes a <a href="code/03_parallel_jobs/count_pi_estimates.py">simple program</a> to count the number of occurences of pi along the lines of:</p>

<div class="python highlighter-rouge"><pre class="highlight"><code>import sys

if __name__=='__main__':

    current_file = open(sys.argv[1])
    current_file_content = current_file.read()
    count = 0
    for line in current_file_content:
        if line.startswith("3.1"):
            count += 1
    
    print(count)

</code></pre>
</div>

<p>She launches the application and waits for quite a while until the she receives an answer (1 minute in this case). She thinks that this is strange. Looking through a some lines of text and checking if a line starts with <code class="highlighter-rouge">3.1</code> doesn’t sound complicated, so why is it taking so long. She expected to get an answer back instantly. Given that she has 16 of these files, if she wants to look through all of them, this means that she has to wait at least 16 minutes for the answer to come along.</p>

<p>Lola wonders, but what do we have a cluster for then? She decides to submit 16 jobs that filter out the estimates of pi for each file. She sits down and alters her previous program to <a href="code/03_parallel_jobs/filter_pi_estimates.py">filter-out the occurences of pi</a>. The idea of her code is the following:</p>

<div class="python highlighter-rouge"><pre class="highlight"><code>import sys

if __name__=='__main__':

    current_file = open(sys.argv[1])
    current_file_content = current_file.read()

    for line in current_file_content:
        if line.startswith("3.1"):
            print(line)
            
</code></pre>
</div>

<p>She tests her python program on a single input file. As she knows how long it’ll take approximately, she can provide a good estimate of the runtime of the job. If the cluster is busy, that allows the scheduler to start her job faster.</p>

<div class="bash highlighter-rouge"><pre class="highlight"><code>$ bsub -W 00:05 -o filter-pi.log -e filter-pi.err python3 filter_pi_estimates.py pi_estimate_01.data
</code></pre>
</div>

<div class="output highlighter-rouge"><pre class="highlight"><code>3.142096
3.141306
3.140558
3.142311
3.141864
3.141112
3.142655
3.140714
</code></pre>
</div>

<p>That went pretty well. She is reminded of the map-reduce idiom that she encountered yesterday. That was the map-step that filters out the occurrences she was interested in. She now needs a reduce step to combine all of these estimates to a global one. If she has all of this, she is basically done recovering her work of yesterday. The <a href="code/03_parallel_jobs/average_pi_estimates.py">code she comes up with</a> is based on her previous programs.</p>

<div class="python highlighter-rouge"><pre class="highlight"><code>import sys

if __name__=='__main__':

    files = sys.argv[1:]
    pi_estimates = []    
    
    for f in files:
        if os.path.exists(f):

            current_file = open(f)
            current_file_content = current_file.read().split("\n")

            for line in current_file_content:
                if line.startswith("3.1"):
                    pi_estimates.append(float(line))
                    
    n_samples = len(pi_estimates)
    print("pi estimates from %i estimates : %f" % (n_samples,sum(pi_estimates)/n_samples))
            
</code></pre>
</div>

<p>The question is, she would love to send this averaging job after she filtered everything out. That means, the averaging depends on the filter step. This can be done with the scheduler she has as:</p>

<div class="bash highlighter-rouge"><pre class="highlight"><code>$ cat map_step.sh
#!/bin/bash

#BSUB -W 00:10
#BSUB -n 1
#BSUB -J "map_step[1-16]"     # define job name and that we want 16 instances
#BSUB -o map_step.%I.log   # file where the output goes (%J is replaced by the job id, %I is replaced by the job index)
#BSUB -e map_step.%I.err   # file where the error messages go

python3 filter_pi_estimates.py pi_estimate_${LSB_JOBINDEX}.data
$ bsub &lt; map_step.sh
</code></pre>
</div>

<p>The above is called an <em>array job</em>. The same commands are executed on an array of files which share a similar filename. In this case, it is <code class="highlighter-rouge">pi_estimate_1.data, pi_estimate_2.data, pi_estimate_3.data, ...</code>. When the job runs on the cluster, the shell variable</p>

<div class="bash highlighter-rouge"><pre class="highlight"><code>${LSB_JOBINDEX} 
</code></pre>
</div>

<p>is replaced by a number within the interval <code class="highlighter-rouge">[1-16]</code>. This way, we receive 16 output files that contain the estimates of Pi we are after. Now that this is done, all the estimates in the output files have to be averaged to provide the final result. As the produced files are only kilo-bytes in size, this can be done without the scheduler.</p>

<div class="bash highlighter-rouge"><pre class="highlight"><code>$ python3 average_pi_estimates.py map_step.1.log map_step.2.log map_step.3.log map_step.4.log 
</code></pre>
</div>

<p>It’s tedious to type in all the 16 file names. Lola asks an admin for help that has been using the terminal for quite a while. He mentions the wildcard character to use.</p>

<div class="bash highlighter-rouge"><pre class="highlight"><code>$ python3 average_pi_estimates.py map_step.*.log
</code></pre>
</div>

<div class="output highlighter-rouge"><pre class="highlight"><code>averaged value of pi from 224 estimates : 3.141337
</code></pre>
</div>


<blockquote class="keypoints">
  <h2>Key Points</h2>
  <ul>
    
  </ul>
</blockquote>


<div class="row">
  <div class="col-md-1">
    <h3>
      
      <a href="../03-02-mpi-for-pi/"><span class="glyphicon glyphicon-menu-left" aria-hidden="true"></span><span class="sr-only">previous episode</span></a>
      
    </h3>
  </div>
  <div class="col-md-10">
    
  </div>
  <div class="col-md-1">
    <h3>
      
      <a href="../"><span class="glyphicon glyphicon-menu-up" aria-hidden="true"></span><span class="sr-only">lesson home</span></a>
      
    </h3>
  </div>
</div>


      
      
<footer>
  <div class="row">
    <div class="col-md-6" align="left">
      <h4>
	Copyright &copy; 2017
	
	<a href="https://software-carpentry.org">Software Carpentry Foundation</a>
	
      </h4>
    </div>
    <div class="col-md-6" align="right">
      <h4>
	<a href="/">Source</a>
	/
	<a href="/blob/gh-pages/CONTRIBUTING.md">Contributing</a>
	/
	<a href="/blob/gh-pages/CITATION">Cite</a>
	/
	<a href="">Contact</a>
      </h4>
    </div>
  </div>
</footer>

      
    </div>
    
<script src="../assets/js/jquery.min.js"></script>
<script src="../assets/js/bootstrap.min.js"></script>
<script src="../assets/js/lesson.js"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-37305346-2', 'auto');
  ga('send', 'pageview');
</script>

  </body>
</html>
